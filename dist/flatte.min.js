/**
 *
 * Nosql denormalization management for Firabase
 * @link https://flatte.github.io/Flatte-Web/
 * @version v.1.0.1-beta.82 - Fri Sep 01 2017 16:24:07 GMT+0300 (Türkiye Standart Saati)
 *
 * Copyright (c) 2017 Flatte - Sezer Ekinci <sezer@maxabab.com>, Kaan Ekinci <kaan@maxabab.com>
 * @license MIT License, https://opensource.org/licenses/MIT
 *
 * @author Sezer Ekinci <sezer@maxabab.com>
 * @author Kaan Ekinci <kaan@maxabab.com>
 *
 * @Controbutors https://github.com/Flatte/Flatte-Web/graphs/contributors
 *
 */
!function(){"use strict";function flatteProvider(){function e(e,t){return{settings:n,checkConnection:function(){return e(function(e,t){if(!n.con||!n.con.database){var a={code:"FB000",message:"Connection Error: settings.con is not defined."};return console.error("[Flatte] Connection Error: ",a),t(a),!1}n.con.database().ref(".info/connected").once("value",function(t){n.debug&&console.info("%c♣ [Flatte] Connection Success.","color:#3883fa;"),n.conStatus=!0,e(!0)},function(e){return n.debug&&console.error("[Flatte] Connection Error: ",e),n.conStatus=!1,t(e),!1})})}}}var t=this,n={debug:!1,baseRef:"/",conStatus:!1,con:null,manifest:[],predefined:{".true":!0,".false":!1,".id":function(){return firebase.database().ref().push().key},".timestamp":firebase.database.ServerValue.TIMESTAMP,".auth":!1}};t.settings=function(e){angular.extend(n,e)},t.$get=e,e.$inject=["$q","$injector"]}function flatteRun(e){e.checkConnection()}function flatte(mxFlatte,$q,$filter,$timeout){function debug(e){mxFlatte.settings.debug&&(angular.isObject(e)?console.info("%c♣ ["+e.code+"] "+e.message,"color:#3883fa;"):console.info("%c♣ "+e,"color:#3883fa;"))}function serial(e){var t;return angular.forEach(e,function(e,n){t=t?t.then(e).catch(function(e){return $q.reject(e)}):e()}),t||$q.when()}function doAction(saveObjects,progress){function createAction(){return f.debug("Create action."),progress[guid].count++,progress[guid].message="Create action...",$q(function(e,t){if(f.debug("Set action container."),doAction.var[guid]={log:{startedAt:getTime()},objects:{},results:{},appliedManifest:[],eliminatedCodes:["01 - Parent result has been found."]},f.debug("Check sent data"),!saveObjects){var n={code:"F001",message:"Object not found! Please send object first."};return endAction(n),t(n),!1}if(!angular.isArray(saveObjects)){var n={code:"F002",message:"Object is not array! Please send object as an array."};return endAction(n),t(n),!1}e()})}function createObjects(){f.debug("Create objects."),progress[guid].count++,progress[guid].message="Create objects...";var e=[];return angular.forEach(saveObjects,function(t){e.push($q(function(e,n){if(t.ref||(t.ref=""),!t.data){var a={code:"F004",message:"Object data not found! Please send object data first. (ref: "+t.ref+")"};return endAction(a),n(a),!1}doAction.var[guid].objects[t.ref]={ref:t.ref,data:t.data,set:t.set,$action:"delete"===t.data?"delete":"save",$exists:{},$ids:{},$ref:""!==t.ref&&"/"!==t.ref?t.ref.split("/"):[],$results:{},$eliminateds:{}},"delete"!==t.data&&(doAction.var[guid].objects[t.ref].$exists[t.ref]=!0),createLoopData(doAction.var[guid].objects[t.ref]).then(function(){e()}).catch(function(e){return n(e),!1})}))}),$q.all(e)}function getDbData(e){return $q(function(t,n){firebase.database().ref(f.baseRef()+"/"+e).once("value",function(e){t(e.val()||{})},function(e){return n(e),!1})})}function createExists(e,t,n){var a=[];return angular.forEach(t,function(t,i){a.push($q(function(a,o){var r=n?angular.copy(n):[];r.push(i),doAction.var[guid].objects[e].$exists[r.join("/")]=!0,angular.isObject(t)?createExists(e,t,r).then(function(){a()}).catch(function(e){return o(e),!1}):a()}))}),$q.all(a)}function createLoopData(e){return f.debug("Create loop data."),progress[guid].count++,progress[guid].message="Create loop data...",$q(function(t,n){"save"!==e.$action||e.set?getDbData(e.ref).then(function(a){e.set?createExists(e.ref,e.data,e.$ref).then(function(){doAction.var[guid].objects[e.ref].data=angular.extend(a,doAction.var[guid].objects[e.ref].data),t()}).catch(function(e){return n(e),!1}):(doAction.var[guid].objects[e.ref].data=a,t())}).catch(function(e){return n(e),!1}):t()})}function perform(){f.debug("Perform."),progress[guid].count++,progress[guid].message="Perform...";var e=[];return angular.forEach(doAction.var[guid].objects,function(t){e.push($q(function(e,n){createIdPaths(t.ref,t.$ref).then(function(a){applyManifest(t.ref,t.data,t.$ref,a).then(function(){e()}).catch(function(e){return n(e),!1})}).catch(function(e){return n(e),!1})})),e.push($q(function(e,n){loopData(t.ref,t.data,t.$ref).then(function(){e()}).catch(function(e){return n(e),!1})}))}),$q.all(e)}function loopData(e,t,n){var a=[];return angular.forEach(t,function(t,i){var o=n?angular.copy(n):[];o.push(i),a.push($q(function(n,a){angular.isObject(t)?loopData(e,t,o).then(function(){n()}).catch(function(e){return a(e),!1}):n()})),a.push($q(function(n,a){createIdPaths(e,o).then(function(i){applyManifest(e,t,o,i).then(function(){n()}).catch(function(e){return a(e),!1})}).catch(function(e){return a(e),!1})}))}),$q.all(a)}function createIdPaths(ref,path){function findID(findPath){var promises=[],ID=!1;return angular.forEach(eval("mxFlatte.settings.manifest.data"+(findPath.length>0?"['"+findPath.join("'].childs['")+"'].childs":"")),function(e,t){promises.push($q(function(n,a){e.hasOwnProperty("_q")&&e._q.hasOwnProperty("ID")&&(ID=t),n()}))}),$q(function(e){$q.all(promises).then(function(t){e(ID)}).catch(function(e){return reject(e),!1})})}var promises=[],newPath=[],hasItem=!1,notFound=!1;return angular.forEach(path,function(item){promises.push(function(){return $q(function(resolve,reject){try{hasItem=eval("mxFlatte.settings.manifest.data"+(newPath.length>0?"['"+newPath.join("'].childs['")+"'].childs":"")+".hasOwnProperty('"+item+"')")}catch(e){hasItem=!1}hasItem?(newPath.push(item),resolve()):findID(newPath).then(function(e){e?newPath.push(e):notFound=notFound||!0,resolve()}).catch(function(e){return reject(e),!1})})})}),$q(function(e,t){f.serial(promises).then(function(){e(!notFound&&newPath)}).catch(function(e){return t(e),!1})})}function applyManifest(ref,data,path,manifestPath){return $q(function(resolve,reject){var manifest={},promises=[],action;action=doAction.var[guid].objects[ref].$exists[path.join("/")]||"permanent"!==doAction.var[guid].objects[ref].set?"permanent"!==doAction.var[guid].objects[ref].set&&("delete"===doAction.var[guid].objects[ref].$action||"save"===doAction.var[guid].objects[ref].$action&&!doAction.var[guid].objects[ref].$exists[path.join("/")]&&doAction.var[guid].objects[ref].set)?"delete":null===data?"delete":"save":"setNull",manifest=!1;try{manifest=eval("mxFlatte.settings.manifest.data"+(manifestPath.length>0?"['"+manifestPath.join("'].childs['")+"']":"")+"._q")}catch(e){return manifest=!1,reject(e),!1}manifestPath.length>0&&!doAction.var[guid].appliedManifest.hasOwnProperty(manifestPath.join("/"))&&doAction.var[guid].appliedManifest.push(manifestPath.join("/"));for(var command in commands)promises.push($q(function(e,t){commands[command](ref,data,path,manifest&&manifest.hasOwnProperty(command)&&""!==manifest[command]?manifest[command]:null,action,manifestPath).then(function(t){$.extend(doAction.var[guid].objects[ref].$results,t),e()}).catch(function(e){return t(e),!1})}));$q.all(promises).then(function(){resolve()}).catch(function(e){return reject(e),!1})})}function createFinalResults(){function e(){function e(e,t){var n=[];return Object.keys(doAction.var[guid].objects[e].$results).reverse().map(function(a){n.push($q(function(n,i){a!==t&&a.split("/").slice(0,t.split("/").length).join("/")===t&&(doAction.var[guid].objects[e].$eliminateds[a]="[01] "+doAction.var[guid].objects[e].$results[a],delete doAction.var[guid].objects[e].$results[a]),n()}))}),$q(function(e,t){$q.all(n).then(function(){e()}).catch(function(e){return t(e),!1})})}function t(t){var n=[];return Object.keys(doAction.var[guid].objects[t].$results).reverse().map(function(a){n.push(function(){$q(function(n,i){angular.isObject(doAction.var[guid].objects[t].$results[a])?(delete doAction.var[guid].objects[t].$results[a],n()):void 0!==doAction.var[guid].objects[t].$results[a]&&e(t,a).then(function(e){n()}).catch(function(e){return i(e),!1})})})}),f.serial(n)}var n=[];return angular.forEach(doAction.var[guid].objects,function(e){n.push($q(function(n,a){t(e.ref).then(function(){n()}).catch(function(e){return a(e),!1})}))}),$q.all(n)}function t(){var e=[];return angular.forEach(doAction.var[guid].objects,function(t){e.push($q(function(e,n){replacePredefined(t.$results).then(function(n){doAction.var[guid].objects[t.ref].$results=n,$.extend(doAction.var[guid].results,n),e()}).catch(function(e){return n(e),!1})}))}),$q.all(e)}return f.debug("Create final results."),progress[guid].count++,progress[guid].message="Create final results...",f.serial([e,t])}function replacePredefined(e){var t=[],n={};return angular.forEach(e,function(e,a){t.push($q(function(t,i){var o,r;"string"==typeof e?(r=e.replace(/\([^\)]*\)/g,"()")?e.replace(/\([^\)]*\)/g,"()").replace("()",""):e,r&&(o=e.match(/\([^\)]*\)/g)),o&&(o=o[0].replace("(","").replace(")","").replace(/(\")|(\')/g,""))):r=e,n[a]=mxFlatte.settings.predefined.hasOwnProperty(r)?"function"==typeof mxFlatte.settings.predefined[r]?mxFlatte.settings.predefined[r](o):mxFlatte.settings.predefined[r]:r,t()}))}),$q(function(e,a){$q.all(t).then(function(){e(n)})})}function update(){return f.debug("Run Update."),progress[guid].count++,progress[guid].message="Run results...",$q(function(e,t){try{firebase.database().ref(f.baseRef()).update(doAction.var[guid].results,function(n){n?t(n):e()})}catch(e){t(e)}})}function endAction(e){return f.debug("End action."),$q(function(t,n){doAction.var[guid].log.endedAt=getTime(),doAction.var[guid].log.duration=doAction.var[guid].log.endedAt-doAction.var[guid].log.startedAt+" milliseconds",doAction.var[guid].log._error=e||null,t()})}f.debug("flatte.do() called...");var getTime=function(){return(new Date).valueOf()},guid="doID"+f.dbKey(),placeIDs=function(e,t,n,a){function i(e,t,n){return $q(function(i){var r=!1;t.map(function(t,i){o.push($q(function(o){a+t===n&&(r=e[i]),o()}))}),$q.all(o).then(function(){i(r)}).catch(function(e){console.log(e)})})}var o=[],r=[];return n.map(function(n){o.push($q(function(a){t?i(e,t,n).then(function(e){e?r.push(e):r.push(n),a()}):(r.push(n),a())}))}),$q(function(e){$q.all(o).then(function(){e(r)}).catch(function(e){console.log(e)})})},commands={ID:function(e,t,n,a,i,o){return $q(function(e,t){e()})},saveValue:function(e,t,n,a,i,o){return $q(function(e,r){var u={};if(".doNothing"!==a&&"save"===i)if(n=angular.isObject(n)?n.join("/"):n,angular.isObject(a))if(a.filter){var c=a.hasOwnProperty("params")?a.params.split("|"):[];c.unshift(t),u[n]=$filter(a.filter).apply(this,c)}else u[n]=t;else u[n]=null===a||"$"===a?t:a;(function(e){var t=[],a={},i="",r="";return angular.forEach(e,function(e,a){"string"==typeof a?t.push($q(function(e){placeIDs(n.split("/"),o,a.split("/"),"#").then(function(t){i=t.join("/"),e()})})):i=a,"string"==typeof e?t.push($q(function(t){placeIDs(n.split("/"),o,e.split("/"),"#").then(function(e){r=e.join("/"),t()})})):r=e}),$q(function(e){$q.all(t).then(function(t){""!==i&&""!==r&&(a[i]=r),e(a)})})})(u).then(function(t){e(t)})})},deleteValue:function(e,t,n,a,i,o){return $q(function(e,r){var u={};".doNothing"!==a&&(n=angular.isObject(n)?n.join("/"):n,"delete"===i?u[n]="$"===a?t:null===a||"null"===a?null:a:"setNull"===i&&(u[n]=null)),function(e){var t=[],a={},i="",r="";return angular.forEach(e,function(e,a){"string"==typeof a?t.push($q(function(e){placeIDs(n.split("/"),o,a.split("/"),"#").then(function(t){i=t.join("/"),e()})})):i=a,"string"==typeof e?t.push($q(function(t){placeIDs(n.split("/"),o,e.split("/"),"#").then(function(e){r=e.join("/"),t()})})):r=e}),$q(function(e){$q.all(t).then(function(t){""!==i&&""!==r&&(a[i]=r),e(a)})})}(u).then(function(t){e(t)})})},copy:function(e,t,n,a,i,o){return $q(function(r,u){function c(t,a,i,r){var u=[];return u.push($q(function(u,c){placeIDs(n,o,t.split("/"),"#").then(function(t){placeIDs(n,o,i.saveValue.split("/"),"#").then(function(n){commands.saveValue(e,a,t.join("/"),n.join("/"),r,o).then(function(e){angular.extend(f,e),u()}).catch(function(e){return c(e),!1})})})})),u.push($q(function(u,c){placeIDs(n,o,t.split("/"),"#").then(function(t){placeIDs(n,o,i.deleteValue.split("/"),"#").then(function(n){commands.deleteValue(e,a,t.join("/"),n.join("/"),r,o).then(function(e){angular.extend(f,e),u()}).catch(function(e){return c(e),!1})})})})),$q.all(u)}function s(e,t,n,a){var i=[];return("save"!==a||null!==n.saveValue&&"$"!==n.saveValue&&""!==n.saveValue.trim())&&("save"===a||null!==n.deleteValue&&"$"!==n.deleteValue&&""!==n.deleteValue.trim())||!angular.isObject(t)?i.push($q(function(i,o){c(e,t,n,a).then(function(e){i(e)}).catch(function(e){return o(e),!1})})):angular.forEach(t,function(t,o){i.push($q(function(i,r){n.saveValue=""!==n.saveValue.trim()?n.saveValue:"$",n.deleteValue=""!==n.deleteValue.trim()?n.deleteValue:"$",s(e+"/"+o,t,n,a).then(function(e){i(e)}).catch(function(e){return r(e),!1})}))}),$q.all(i)}if(!a)return r(),!1;var f={},l=[];a&&a.map(function(e){l.push($q(function(n,a){s(e.path,t,e,i).then(function(e){n()}).catch(function(e){return a(e),!1})}))}),$q.all(l).then(function(e){r(f)}).catch(function(e){return u(e),!1})})},externalEffect:function(e,t,n,a,i,o){return $q(function(r,u){function c(e){var t=[],a={path:"",if:{key:"",value:""},save:{key:"",value:""},delete:{key:"",value:""}};return e.hasOwnProperty("path")||(e.path=""),t.push($q(function(t){placeIDs(n,o,e.path.split("/"),"#").then(function(e){a.path=e.join("/"),t()})})),e.hasOwnProperty("if")?(e.if.hasOwnProperty("key")||(e.if.key=""),e.if.hasOwnProperty("value")||(e.if.value="")):e.if={key:"",value:""},t.push($q(function(t){placeIDs(n,o,e.if.key.split("/"),"#").then(function(e){a.if.key=e.join("/"),t()})})),t.push($q(function(t){placeIDs(n,o,e.if.value.split("/"),"#").then(function(e){a.if.value=e.join("/"),t()})})),e.hasOwnProperty("save")?(e.save.hasOwnProperty("key")||(e.save.key=""),e.save.hasOwnProperty("value")||(e.save.value="")):e.if={key:"",value:""},t.push($q(function(t){placeIDs(n,o,e.save.key.split("/"),"#").then(function(e){a.save.key=e.join("/"),t()})})),t.push($q(function(t){placeIDs(n,o,e.save.value.split("/"),"#").then(function(e){a.save.value=e.join("/"),t()})})),e.hasOwnProperty("delete")?(e.delete.hasOwnProperty("key")||(e.delete.key=""),e.delete.hasOwnProperty("value")||(e.delete.value="")):e.delete={key:"",value:""},t.push($q(function(t){placeIDs(n,o,e.delete.key.split("/"),"#").then(function(e){a.delete.key=e.join("/"),t()})})),t.push($q(function(t){placeIDs(n,o,e.delete.value.split("/"),"#").then(function(e){a.delete.value=e.join("/"),t()})})),$q(function(e,n){$q.all(t).then(function(){var t,n;"string"==typeof a.if.value?(n=a.if.value.replace(/\([^\)]*\)/g,"()")?a.if.value.replace(/\([^\)]*\)/g,"()").replace("()",""):a.if.value,n&&(t=a.if.value.match(/\([^\)]*\)/g)),t&&(t=t[0].replace("(","").replace(")","").replace(/(\")|(\')/g,""))):n=a.if.value,a.if.value=mxFlatte.settings.predefined.hasOwnProperty(n)?"function"==typeof mxFlatte.settings.predefined[n]?mxFlatte.settings.predefined[n](t):mxFlatte.settings.predefined[a.if.value]:a.if.value,e(a)})})}function s(t,n,a,i){var r=[];return".doNothing"!==a.save.value&&("save"===i?r.push($q(function(r,u){commands.saveValue(e,"1",(n+"/"+a.save.key).split("/"),a.save.value,i,o).then(function(e){angular.equals(t,e)||angular.extend(d,e),r()}).catch(function(e){return u(e),!1})})):r.push($q(function(r,u){commands.deleteValue(e,t,(n+"/"+a.delete.key).split("/"),a.delete.value,i,o).then(function(e){angular.equals(t,e)||angular.extend(d,e),r()}).catch(function(e){return u(e),!1})}))),$q.all(r)}function l(e,t,n,a){var i=[];return angular.forEach(e,function(e,o){i.push($q(function(e,i){s(t,n.path+"/"+o,n,a).then(function(){e()}).catch(function(e){return i(e),!1})}))}),$q.all(i)}if(!a)return r(),!1;var d={},h=[];angular.forEach(a,function(e){h.push($q(function(n,a){c(e).then(function(e){firebase.database().ref(f.baseRef()+"/"+e.path).orderByChild(e.if.key).equalTo(e.if.value).once("value",function(o){l(o.val(),t,e,i).then(function(e){n()}).catch(function(e){return a(e),!1})},function(e){a(e)})})}))}),$q.all(h).then(function(e){r(d)})})},function:function(ref,data,path,options,action,manifestPath){function replace(e){var t=[],n={},a="",i="";return angular.forEach(e,function(e,n){"string"==typeof n&&t.push($q(function(e){placeIDs(path,manifestPath,n.split("/"),"#").then(function(t){a=t.join("/"),e()})})),"string"==typeof e&&t.push($q(function(t){placeIDs(path,manifestPath,e.split("/"),"#").then(function(e){i=e.join("/"),t()})}))}),$q(function(e){$q.all(t).then(function(t){""!==a&&""!==i&&(n[a]=i),e(n)})})}function $function(flatte,$q,$ref,$data,$path,$action,$manifestPath){return $q(function(resolve,reject){try{var res={};eval(options)}catch(e){return reject(e),!1}})}return $q(function(e,t){options?$function(f,$q,ref,data,path,action,manifestPath).then(function(t){e(t)}).catch(function(e){return t(e),!1}):e()})}},tasks=[createAction,createObjects,loopData,perform,createFinalResults,update,endAction];return progress[guid]={total:8},progress[guid].count=0,progress[guid].message="Pending...",$q(function(e,t){f.serial(tasks).then(function(){mxFlatte.settings.debug?e({results:doAction.var[guid].results||"No save result generated !..",manifestInfections:doAction.var[guid].appliedManifest}):(delete doAction.var[guid],e()),f.debug("flatte.do() ended with success"),progress[guid].count++,progress[guid].message="End action..."}).catch(function(e){endAction(e),t(e),f.debug("flatte.do() ended with error")})})}var f=this;f.debug=debug,f.serial=serial,f.db=firebase.database(),f.dbref=f.db.ref(),f.dbTime=function(){return firebase.database.ServerValue.TIMESTAMP},f.dbKey=function(){return firebase.database().ref().push().key},f.cleanData=function(e){return JSON.parse(JSON.serialize(e))},f.setManifest=function(e){mxFlatte.settings.manifest=angular.copy(e)},f.setPredefined=function(e){mxFlatte.settings.predefined=e},f.predefined=function(e,t){if(!e)return mxFlatte.settings.predefined;"object"==typeof e?angular.forEach(e,function(e,t){mxFlatte.settings.predefined[t]=e}):mxFlatte.settings.predefined[e]=t},f.baseRef=function(e){if(!e)return mxFlatte.settings.baseRef;mxFlatte.settings.baseRef=e},f.do=doAction,doAction.var={},doAction.getDebug=function(){return this.var},doAction.clearDebug=function(){this.var={}}}angular.module("mx.flatte",[]).provider("mxFlatte",flatteProvider).run(flatteRun).service("flatte",flatte),flatteProvider.$inject=[],flatteRun.$inject=["mxFlatte"],flatte.$inject=["mxFlatte","$q","$filter","$timeout"]}();