/**
 *
 * Nosql denormalization management for Firabase
 * @link https://flatte.github.io/Flatte-Web/
 * @version v.1.0.1-beta.72 - Sat Aug 26 2017 19:46:43 GMT+0300 (Türkiye Standart Saati)
 *
 * Copyright (c) 2017 Flatte - Sezer Ekinci <sezer@maxabab.com>, Kaan Ekinci <kaan@maxabab.com>
 * @license MIT License, https://opensource.org/licenses/MIT
 *
 * @author Sezer Ekinci <sezer@maxabab.com>
 * @author Kaan Ekinci <kaan@maxabab.com>
 *
 * @Controbutors https://github.com/Flatte/Flatte-Web/graphs/contributors
 *
 */
!function(){"use strict";function flatteProvider(){function t(t,e){return{settings:n,checkConnection:function(){return t(function(t,e){if(!n.con||!n.con.database){var a={code:"FB000",message:"Connection Error: settings.con is not defined."};return console.error("[Flatte] Connection Error: ",a),e(a),!1}n.con.database().ref(".info/connected").once("value",function(e){n.debug&&console.info("%c♣ [Flatte] Connection Success.","color:#3883fa;"),n.conStatus=!0,t(!0)},function(t){return n.debug&&console.error("[Flatte] Connection Error: ",t),n.conStatus=!1,e(t),!1})})}}}var e=this,n={debug:!1,baseRef:"/",conStatus:!1,con:null,manifest:null,predefined:{".timestamp":firebase.database.ServerValue.TIMESTAMP,".auth":!1,".id":function(){return firebase.database().ref().push().key}}};e.settings=function(t){angular.extend(n,t)},e.$get=t,t.$inject=["$q","$injector"]}function flatteRun(t){t.checkConnection()}function flatte(mxFlatte,$q,$filter){function debug(t){mxFlatte.settings.debug&&(angular.isObject(t)?console.info("%c♣ ["+t.code+"] "+t.message,"color:#3883fa;"):console.info("%c♣ "+t,"color:#3883fa;"))}function serial(t){var e;return angular.forEach(t,function(t,n){e=e?e.then(t).catch(function(t){return $q.reject(t)}):t()}),e||$q.when()}function doAction(saveObjects){function createAction(){return f.debug("Create action."),$q(function(t,e){if(f.debug("Set action container."),doAction.var[guid]={log:{startedAt:getTime()},objects:{},results:{},appliedManifest:[]},f.debug("Check sent data"),!saveObjects){var n={code:"F001",message:"Object not found! Please send object first."};return endAction(n),e(n),!1}if(!angular.isArray(saveObjects)){var n={code:"F002",message:"Object is not array! Please send object as an array."};return endAction(n),e(n),!1}t()})}function createObjects(){var t=[];return angular.forEach(saveObjects,function(e){t.push($q(function(t,n){if(e.ref||(e.ref=""),!e.data){var a={code:"F004",message:"Object data not found! Please send object data first. (ref: "+e.ref+")"};return endAction(a),n(a),!1}doAction.var[guid].objects[e.ref]={ref:e.ref,data:e.data,set:e.set,$action:"delete"===e.data?"delete":"save",$exists:{},$ids:{},$ref:""!==e.ref&&"/"!==e.ref?e.ref.split("/"):[],$results:{}},"delete"!==e.data&&(doAction.var[guid].objects[e.ref].$exists[e.ref]=!0),createLoopData(doAction.var[guid].objects[e.ref]).then(function(){t()}).catch(function(t){return n(t),!1})}))}),$q.all(t)}function getDbData(t){return $q(function(e,n){firebase.database().ref(f.baseRef()+"/"+t).once("value",function(t){e(t.val()||{})},function(t){return n(t),!1})})}function createExists(t,e,n){var a=[];return angular.forEach(e,function(e,r){a.push($q(function(a,o){var i=n?angular.copy(n):[];i.push(r),doAction.var[guid].objects[t].$exists[i.join("/")]=!0,angular.isObject(e)?createExists(t,e,i).then(function(){a()}).catch(function(t){return o(t),!1}):a()}))}),$q.all(a)}function createLoopData(t){return $q(function(e,n){"save"!==t.$action||t.set?getDbData(t.ref).then(function(a){t.set?createExists(t.ref,t.data,t.$ref).then(function(){doAction.var[guid].objects[t.ref].data=angular.extend(a,doAction.var[guid].objects[t.ref].data),e()}).catch(function(t){return n(t),!1}):(doAction.var[guid].objects[t.ref].data=a,e())}).catch(function(t){return n(t),!1}):e()})}function perform(){var t=[];return angular.forEach(doAction.var[guid].objects,function(e){t.push($q(function(t,n){createIdPaths(e.ref,e.$ref).then(function(a){applyManifest(e.ref,e.data,e.$ref,a).then(function(){t()}).catch(function(t){return n(t),!1})}).catch(function(t){return n(t),!1})})),t.push($q(function(t,n){loopData(e.ref,e.data,e.$ref).then(function(){t()}).catch(function(t){return n(t),!1})}))}),$q.all(t)}function loopData(t,e,n){var a=[];return angular.forEach(e,function(e,r){var o=n?angular.copy(n):[];o.push(r),a.push($q(function(n,a){angular.isObject(e)?loopData(t,e,o).then(function(){n()}).catch(function(t){return a(t),!1}):n()})),a.push($q(function(n,a){createIdPaths(t,o).then(function(r){applyManifest(t,e,o,r).then(function(){n()}).catch(function(t){return a(t),!1})}).catch(function(t){return a(t),!1})}))}),$q.all(a)}function createIdPaths(ref,path){return $q(function(resolve,reject){var promises=[],newPath=[],hasItem=!1,notFound=!1;return angular.forEach(path,function(item){promises.push($q(function(resolve,reject){try{hasItem=eval("mxFlatte.settings.manifest.data"+(newPath.length>0?"['"+newPath.join("'].childs['")+"'].childs":"")+".hasOwnProperty('"+item+"')")}catch(t){hasItem=!1}if(hasItem)newPath.push(item),resolve();else{if(mxFlatte.settings.manifest.hasOwnProperty("id_index")&&mxFlatte.settings.manifest.id_index.hasOwnProperty(newPath.join(">")+">ID")){var ID=mxFlatte.settings.manifest.id_index[newPath.join(">")+">ID"];ID?(newPath.push(ID),doAction.var[guid].objects[ref].$ids["#"+ID]=item):notFound=notFound||!0}else notFound=notFound||!0;resolve()}}))}),$q.all(promises).then(function(){resolve(!notFound&&newPath)}).catch(function(t){return reject(t),!1})})}function applyManifest(ref,data,path,manifestPath){return $q(function(resolve,reject){var manifest={},promises=[],action;action=doAction.var[guid].objects[ref].$exists[path.join("/")]||"permanent"!==doAction.var[guid].objects[ref].set?"permanent"!==doAction.var[guid].objects[ref].set&&("delete"===doAction.var[guid].objects[ref].$action||"save"===doAction.var[guid].objects[ref].$action&&!doAction.var[guid].objects[ref].$exists[path.join("/")]&&doAction.var[guid].objects[ref].set)?"delete":"save":"setNull",manifest=!1;try{manifest=eval("mxFlatte.settings.manifest.data"+(manifestPath.length>0?"['"+manifestPath.join("'].childs['")+"']":"")+"._q")}catch(t){return manifest=!1,reject(t),!1}if(manifest){doAction.var[guid].appliedManifest.push(manifestPath.length>0?manifestPath.join("/"):"");for(var command in commands)promises.push($q(function(t,e){commands[command](ref,data,path,manifest&&manifest.hasOwnProperty(command)&&""!==manifest[command]?manifest[command]:null,action).then(function(e){$.extend(doAction.var[guid].objects[ref].$results,e),t()}).catch(function(t){return e(t),!1})}))}$q.all(promises).then(function(){resolve()}).catch(function(t){return reject(t),!1})})}function createFinalResults(){var t=[];return angular.forEach(doAction.var[guid].objects,function(e){t.push($q(function(t,n){_replace(e.ref,e.$results).then(function(n){doAction.var[guid].objects[e.ref].$results=n,$.extend(doAction.var[guid].results,n),t()}).catch(function(t){return n(t),!1})}))}),$q.all(t)}function _replace(t,e){var n=[],a={};return angular.forEach(e,function(e,r){n.push($q(function(n,o){_replaceIDs(t,r).then(function(r){_replaceIDs(t,e).then(function(t){a[r]=mxFlatte.settings.predefined.hasOwnProperty(t)?"function"==typeof mxFlatte.settings.predefined[t]?mxFlatte.settings.predefined[t]():mxFlatte.settings.predefined[t]:t,n()}).catch(function(t){return o(t),!1})}).catch(function(t){return o(t),!1})}))}),$q(function(t,e){$q.all(n).then(function(){t(a)})})}function _replaceIDs(t,e){var n=[],a=angular.copy(e);return a&&"string"==typeof a&&angular.forEach(doAction.var[guid].objects[t].$ids,function(t,e){n.push($q(function(n,r){var o=new RegExp(e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),"g");a=a.replace(o,t),n()}))}),$q(function(t,e){$q.all(n).then(function(){t("string"==typeof a?a.trim().replace(/(\/+)/g,"/").replace(/(^\/+)|(\/+$)/gi,""):a)})})}function update(){return f.debug("Run Update."),$q(function(t,e){firebase.database().ref(f.baseRef()).update(doAction.var[guid].results,function(n){n?e(n):t()})})}function endAction(t){return $q(function(e,n){doAction.var[guid].log.endedAt=getTime(),doAction.var[guid].log.duration=doAction.var[guid].log.endedAt-doAction.var[guid].log.startedAt+" milliseconds",doAction.var[guid].log._error=t||null,e()})}f.debug("flatte.do() called...");var getTime=function(){return(new Date).valueOf()},guid="GUID"+f.dbKey(),commands={ID:function(t,e,n,a,r){return $q(function(t,e){t()})},saveValue:function(t,e,n,a,r){return $q(function(t,o){var i={};if(".doNothing"!==a&&"save"===r&&!angular.isObject(e))if(n=angular.isObject(n)?n.join("/"):n,angular.isObject(a))if(a.filter){var c=a.hasOwnProperty("params")?a.params.split("|"):[];c.unshift(e),i[n]=$filter(a.filter).apply(this,c)}else i[n]=e;else i[n]=null===a||"$"===a?e:a;t(i)})},deleteValue:function(t,e,n,a,r){return $q(function(t,o){var i={};".doNothing"===a||angular.isObject(e)||(n=angular.isObject(n)?n.join("/"):n,"delete"===r?i[n]="$"===a?e:null===a||"null"===a?null:a:"setNull"===r&&(i[n]=null)),t(i)})},copy:function(t,e,n,a,r){return $q(function(n,o){function i(e,n,a,r){var o=[];return o.push($q(function(o,i){commands.saveValue(t,n,e,a.saveValue,r).then(function(t){angular.extend(u,t),o()}).catch(function(t){return i(t),!1})})),o.push($q(function(o,i){commands.deleteValue(t,n,e,a.deleteValue,r).then(function(t){angular.extend(u,t),o()}).catch(function(t){return i(t),!1})})),$q.all(o)}function c(t,e,n,a){var r=[];return angular.isObject(e)?angular.forEach(e,function(e,o){r.push($q(function(r,i){c(t+"/"+o,e,n,a).then(function(t){r(t)}).catch(function(t){return i(t),!1})}))}):r.push($q(function(r,o){i(t,e,n,a).then(function(t){r(t)}).catch(function(t){return o(t),!1})})),$q.all(r)}if(!a)return n(),!1;var u={},f=[];a&&a.map(function(t){f.push($q(function(n,a){c(t.path,e,t,r).then(function(t){n()}).catch(function(t){return a(t),!1})}))}),$q.all(f).then(function(t){n(u)}).catch(function(t){return o(t),!1})})},externalEffect:function(t,e,n,a,r){return $q(function(n,o){function i(e){return $q(function(n,a){_replace(t,e).then(function(a){e=a,_replace(t,e.if).then(function(a){e.if=a,_replaceIDs(t,e.save.key).then(function(a){e.save.key=a,_replaceIDs(t,e.delete.key).then(function(t){e.delete.key=t,n(e)})})})})})}function c(e,n,a,r){var o=[];return".doNothing"!==a.save.value&&("save"===r?o.push($q(function(e,o){commands.saveValue(t,"1",(n+"/"+a.save.key).split("/"),a.save.value,r).then(function(t){angular.extend(s,t),e()}).catch(function(t){return o(t),!1})})):o.push($q(function(o,i){commands.deleteValue(t,e,(n+"/"+a.delete.key).split("/"),a.delete.value,r).then(function(t){angular.extend(s,t),o()}).catch(function(t){return i(t),!1})}))),$q.all(o)}function u(t,e,n,a){var r=[];return angular.forEach(t,function(t,o){r.push($q(function(t,r){c(e,n.path+"/"+o,n,a).then(function(){t()}).catch(function(t){return r(t),!1})}))}),$q.all(r)}if(!a)return n(),!1;var s={},l=[];angular.forEach(a,function(t){l.push($q(function(n,a){i(t).then(function(t){firebase.database().ref(f.baseRef()+"/"+t.path).orderByChild(t.if.key).equalTo(t.if.value).once("value",function(o){u(o.val(),e,t,r).then(function(t){n()}).catch(function(t){return a(t),!1})},function(t){a(t)})})}))}),$q.all(l).then(function(t){n(s)})})},function:function(ref,data,path,options,action){function $function(flatte,$q,$ref,$data,$path,$action){return $q(function(resolve,reject){try{var res={};eval(options)}catch(t){return reject(t),!1}})}return $q(function(t,e){options?$function(f,$q,ref,data,path,action).then(function(e){t(e)}).catch(function(t){return e(t),!1}):t()})}},tasks=[createAction,createObjects,loopData,perform,createFinalResults,update,endAction];return $q(function(t,e){f.serial(tasks).then(function(){mxFlatte.settings.debug?t({results:doAction.var[guid].results||"No save result generated !..",manifestInfections:doAction.var[guid].appliedManifest}):(delete doAction.var[guid],t()),f.debug("flatte.do() ended with success")}).catch(function(t){e(t)})})}var f=this;f.debug=debug,f.serial=serial,f.db=firebase.database(),f.dbref=f.db.ref(),f.dbTime=function(){return firebase.database.ServerValue.TIMESTAMP},f.dbKey=function(){return firebase.database().ref().push().key},f.cleanData=function(t){return JSON.parse(JSON.serialize(t))},f.setManifest=function(t){mxFlatte.settings.manifest=t},f.setPredefined=function(t){mxFlatte.settings.predefined=t},f.predefined=function(t,e){if(!t)return mxFlatte.settings.predefined;"object"==typeof t?angular.forEach(t,function(t,e){mxFlatte.settings.predefined[e]=t}):mxFlatte.settings.predefined[t]=e},f.baseRef=function(t){if(!t)return mxFlatte.settings.baseRef;mxFlatte.settings.baseRef=t},f.do=doAction,doAction.var={},doAction.getDebug=function(){return this.var}}angular.module("mx.flatte",[]).provider("mxFlatte",flatteProvider).run(flatteRun).service("flatte",flatte),flatteProvider.$inject=[],flatteRun.$inject=["mxFlatte"],flatte.$inject=["mxFlatte","$q","$filter"]}();