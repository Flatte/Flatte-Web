/**
 *
 * Nosql denormalization management for Firabase
 * @link https://flatte.github.io/Flatte-Web/
 * @version v.1.0.1-beta.79 - Tue Aug 29 2017 18:34:00 GMT+0300 (Türkiye Standart Saati)
 *
 * Copyright (c) 2017 Flatte - Sezer Ekinci <sezer@maxabab.com>, Kaan Ekinci <kaan@maxabab.com>
 * @license MIT License, https://opensource.org/licenses/MIT
 *
 * @author Sezer Ekinci <sezer@maxabab.com>
 * @author Kaan Ekinci <kaan@maxabab.com>
 *
 * @Controbutors https://github.com/Flatte/Flatte-Web/graphs/contributors
 *
 */
!function(){"use strict";function flatteProvider(){function t(t,n){return{settings:e,checkConnection:function(){return t(function(t,n){if(!e.con||!e.con.database){var a={code:"FB000",message:"Connection Error: settings.con is not defined."};return console.error("[Flatte] Connection Error: ",a),n(a),!1}e.con.database().ref(".info/connected").once("value",function(n){e.debug&&console.info("%c♣ [Flatte] Connection Success.","color:#3883fa;"),e.conStatus=!0,t(!0)},function(t){return e.debug&&console.error("[Flatte] Connection Error: ",t),e.conStatus=!1,n(t),!1})})}}}var n=this,e={debug:!1,baseRef:"/",conStatus:!1,con:null,manifest:[],predefined:{".true":!0,".false":!1,".id":function(){return firebase.database().ref().push().key},".timestamp":firebase.database.ServerValue.TIMESTAMP,".auth":!1}};n.settings=function(t){angular.extend(e,t)},n.$get=t,t.$inject=["$q","$injector"]}function flatteRun(t){t.checkConnection()}function flatte(mxFlatte,$q,$filter,$timeout){function debug(t){mxFlatte.settings.debug&&(angular.isObject(t)?console.info("%c♣ ["+t.code+"] "+t.message,"color:#3883fa;"):console.info("%c♣ "+t,"color:#3883fa;"))}function serial(t){var n;return angular.forEach(t,function(t,e){n=n?n.then(t).catch(function(t){return $q.reject(t)}):t()}),n||$q.when()}function doAction(saveObjects){function createAction(){return f.debug("Create action."),$q(function(t,n){if(f.debug("Set action container."),doAction.var[guid]={log:{startedAt:getTime()},objects:{},results:{},appliedManifest:[]},f.debug("Check sent data"),!saveObjects){var e={code:"F001",message:"Object not found! Please send object first."};return endAction(e),n(e),!1}if(!angular.isArray(saveObjects)){var e={code:"F002",message:"Object is not array! Please send object as an array."};return endAction(e),n(e),!1}t()})}function createObjects(){var t=[];return angular.forEach(saveObjects,function(n){t.push($q(function(t,e){if(n.ref||(n.ref=""),!n.data){var a={code:"F004",message:"Object data not found! Please send object data first. (ref: "+n.ref+")"};return endAction(a),e(a),!1}doAction.var[guid].objects[n.ref]={ref:n.ref,data:n.data,set:n.set,$action:"delete"===n.data?"delete":"save",$exists:{},$ids:{},$ref:""!==n.ref&&"/"!==n.ref?n.ref.split("/"):[],$results:{}},"delete"!==n.data&&(doAction.var[guid].objects[n.ref].$exists[n.ref]=!0),createLoopData(doAction.var[guid].objects[n.ref]).then(function(){t()}).catch(function(t){return e(t),!1})}))}),$q.all(t)}function getDbData(t){return $q(function(n,e){firebase.database().ref(f.baseRef()+"/"+t).once("value",function(t){n(t.val()||{})},function(t){return e(t),!1})})}function createExists(t,n,e){var a=[];return angular.forEach(n,function(n,i){a.push($q(function(a,o){var u=e?angular.copy(e):[];u.push(i),doAction.var[guid].objects[t].$exists[u.join("/")]=!0,angular.isObject(n)?createExists(t,n,u).then(function(){a()}).catch(function(t){return o(t),!1}):a()}))}),$q.all(a)}function createLoopData(t){return $q(function(n,e){"save"!==t.$action||t.set?getDbData(t.ref).then(function(a){t.set?createExists(t.ref,t.data,t.$ref).then(function(){doAction.var[guid].objects[t.ref].data=angular.extend(a,doAction.var[guid].objects[t.ref].data),n()}).catch(function(t){return e(t),!1}):(doAction.var[guid].objects[t.ref].data=a,n())}).catch(function(t){return e(t),!1}):n()})}function perform(){var t=[];return angular.forEach(doAction.var[guid].objects,function(n){t.push($q(function(t,e){createIdPaths(n.ref,n.$ref).then(function(a){applyManifest(n.ref,n.data,n.$ref,a).then(function(){t()}).catch(function(t){return e(t),!1})}).catch(function(t){return e(t),!1})})),t.push($q(function(t,e){loopData(n.ref,n.data,n.$ref).then(function(){t()}).catch(function(t){return e(t),!1})}))}),$q.all(t)}function loopData(t,n,e){var a=[];return angular.forEach(n,function(n,i){var o=e?angular.copy(e):[];o.push(i),a.push($q(function(e,a){angular.isObject(n)?loopData(t,n,o).then(function(){e()}).catch(function(t){return a(t),!1}):e()})),a.push($q(function(e,a){createIdPaths(t,o).then(function(i){applyManifest(t,n,o,i).then(function(){e()}).catch(function(t){return a(t),!1})}).catch(function(t){return a(t),!1})}))}),$q.all(a)}function createIdPaths(ref,path){function findID(findPath){var promises=[],ID=!1;return angular.forEach(eval("mxFlatte.settings.manifest.data"+(findPath.length>0?"['"+findPath.join("'].childs['")+"'].childs":"")),function(t,n){promises.push($q(function(e,a){t.hasOwnProperty("_q")&&t._q.hasOwnProperty("ID")&&(ID=n),e()}))}),$q(function(t){$q.all(promises).then(function(n){t(ID)}).catch(function(t){return reject(t),!1})})}var promises=[],newPath=[],hasItem=!1,notFound=!1;return angular.forEach(path,function(item){promises.push(function(){return $q(function(resolve,reject){try{hasItem=eval("mxFlatte.settings.manifest.data"+(newPath.length>0?"['"+newPath.join("'].childs['")+"'].childs":"")+".hasOwnProperty('"+item+"')")}catch(t){hasItem=!1}hasItem?(newPath.push(item),resolve()):findID(newPath).then(function(t){t?newPath.push(t):notFound=notFound||!0,resolve()}).catch(function(t){return reject(t),!1})})})}),$q(function(t,n){f.serial(promises).then(function(){t(!notFound&&newPath)}).catch(function(t){return n(t),!1})})}function applyManifest(ref,data,path,manifestPath){return $q(function(resolve,reject){var manifest={},promises=[],action;action=doAction.var[guid].objects[ref].$exists[path.join("/")]||"permanent"!==doAction.var[guid].objects[ref].set?"permanent"!==doAction.var[guid].objects[ref].set&&("delete"===doAction.var[guid].objects[ref].$action||"save"===doAction.var[guid].objects[ref].$action&&!doAction.var[guid].objects[ref].$exists[path.join("/")]&&doAction.var[guid].objects[ref].set)?"delete":"save":"setNull",manifest=!1;try{manifest=eval("mxFlatte.settings.manifest.data"+(manifestPath.length>0?"['"+manifestPath.join("'].childs['")+"']":"")+"._q")}catch(t){return manifest=!1,reject(t),!1}manifestPath.length>0&&!doAction.var[guid].appliedManifest.hasOwnProperty(manifestPath.join("/"))&&doAction.var[guid].appliedManifest.push(manifestPath.join("/"));for(var command in commands)promises.push($q(function(t,n){commands[command](ref,data,path,manifest&&manifest.hasOwnProperty(command)&&""!==manifest[command]?manifest[command]:null,action,manifestPath).then(function(n){$.extend(doAction.var[guid].objects[ref].$results,n),t()}).catch(function(t){return n(t),!1})}));$q.all(promises).then(function(){resolve()}).catch(function(t){return reject(t),!1})})}function createFinalResults(){function t(){function t(t,n){var e=[];return Object.keys(doAction.var[guid].objects[t].$results).sort().map(function(a){e.push($q(function(e,i){a!==n&&a.startsWith(n)&&delete doAction.var[guid].objects[t].$results[a],e()}))}),$q(function(t,n){$q.all(e).then(function(){t()}).catch(function(t){return n(t),!1})})}function n(n){var e=[];return Object.keys(doAction.var[guid].objects[n].$results).sort().map(function(a){e.push(function(){$q(function(e,i){angular.isObject(doAction.var[guid].objects[n].$results[a])?(delete doAction.var[guid].objects[n].$results[a],e()):void 0!==doAction.var[guid].objects[n].$results[a]&&t(n,a).then(function(t){e()}).catch(function(t){return i(t),!1})})})}),f.serial(e)}var e=[];return angular.forEach(doAction.var[guid].objects,function(t){e.push($q(function(e,a){n(t.ref).then(function(){e()}).catch(function(t){return a(t),!1})}))}),$q.all(e)}function n(){var t=[];return angular.forEach(doAction.var[guid].objects,function(n){t.push($q(function(t,e){replacePredefined(n.ref,n.$results).then(function(e){doAction.var[guid].objects[n.ref].$results=e,$.extend(doAction.var[guid].results,e),t()}).catch(function(t){return e(t),!1})}))}),$q.all(t)}return f.serial([t,n])}function replacePredefined(t,n){var e=[],a={};return angular.forEach(n,function(t,n){e.push($q(function(e,i){a[n]=mxFlatte.settings.predefined.hasOwnProperty(t)?"function"==typeof mxFlatte.settings.predefined[t]?mxFlatte.settings.predefined[t]():mxFlatte.settings.predefined[t]:t,e()}))}),$q(function(t,n){$q.all(e).then(function(){t(a)})})}function update(){return f.debug("Run Update."),$q(function(t,n){firebase.database().ref(f.baseRef()).update(doAction.var[guid].results,function(e){e?n(e):t()})})}function endAction(t){return $q(function(n,e){doAction.var[guid].log.endedAt=getTime(),doAction.var[guid].log.duration=doAction.var[guid].log.endedAt-doAction.var[guid].log.startedAt+" milliseconds",doAction.var[guid].log._error=t||null,n()})}f.debug("flatte.do() called...");var getTime=function(){return(new Date).valueOf()},guid="doID"+f.dbKey(),placeIDs=function(t,n,e,a){function i(t,n,e){return $q(function(i){var u=!1;n.map(function(n,i){o.push($q(function(o){a+n===e&&(u=t[i]),o()}))}),$q.all(o).then(function(){i(u)}).catch(function(t){console.log(t)})})}var o=[],u=[];return e.map(function(e){o.push($q(function(a){n?i(t,n,e).then(function(t){t?u.push(t):u.push(e),a()}):(u.push(e),a())}))}),$q(function(t){$q.all(o).then(function(){t(u)}).catch(function(t){console.log(t)})})},commands={ID:function(t,n,e,a,i,o){return $q(function(t,n){t()})},saveValue:function(t,n,e,a,i,o){return $q(function(t,u){var c={};if(".doNothing"!==a&&"save"===i)if(e=angular.isObject(e)?e.join("/"):e,angular.isObject(a))if(a.filter){var r=a.hasOwnProperty("params")?a.params.split("|"):[];r.unshift(n),c[e]=$filter(a.filter).apply(this,r)}else c[e]=n;else c[e]=null===a||"$"===a?n:a;(function(t){var n=[],a={},i="",u="";return angular.forEach(t,function(t,a){"string"==typeof a?n.push($q(function(t){placeIDs(e.split("/"),o,a.split("/"),"#").then(function(n){i=n.join("/"),t()})})):i=a,"string"==typeof t?n.push($q(function(n){placeIDs(e.split("/"),o,t.split("/"),"#").then(function(t){u=t.join("/"),n()})})):u=t}),$q(function(t){$q.all(n).then(function(n){""!==i&&""!==u&&(a[i]=u),t(a)})})})(c).then(function(n){t(n)})})},deleteValue:function(t,n,e,a,i,o){return $q(function(t,u){var c={};".doNothing"!==a&&(e=angular.isObject(e)?e.join("/"):e,"delete"===i?c[e]="$"===a?n:null===a||"null"===a?null:a:"setNull"===i&&(c[e]=null)),function(t){var n=[],a={},i="",u="";return angular.forEach(t,function(t,a){"string"==typeof a?n.push($q(function(t){placeIDs(e.split("/"),o,a.split("/"),"#").then(function(n){i=n.join("/"),t()})})):i=a,"string"==typeof t?n.push($q(function(n){placeIDs(e.split("/"),o,t.split("/"),"#").then(function(t){u=t.join("/"),n()})})):u=t}),$q(function(t){$q.all(n).then(function(n){""!==i&&""!==u&&(a[i]=u),t(a)})})}(c).then(function(n){t(n)})})},copy:function(t,n,e,a,i,o){return $q(function(u,c){function r(n,a,i,u){var c=[];return c.push($q(function(c,r){placeIDs(e,o,n.split("/"),"#").then(function(n){placeIDs(e,o,i.saveValue.split("/"),"#").then(function(e){commands.saveValue(t,a,n.join("/"),e.join("/"),u,o).then(function(t){angular.extend(s,t),c()}).catch(function(t){return r(t),!1})})})})),c.push($q(function(c,r){placeIDs(e,o,n.split("/"),"#").then(function(n){placeIDs(e,o,i.deleteValue.split("/"),"#").then(function(e){commands.deleteValue(t,a,n.join("/"),e.join("/"),u,o).then(function(t){angular.extend(s,t),c()}).catch(function(t){return r(t),!1})})})})),$q.all(c)}function f(t,n,e,a){var i=[];return("save"!==a||null!==e.saveValue&&"$"!==e.saveValue&&""!==e.saveValue.trim())&&("save"===a||null!==e.deleteValue&&"$"!==e.deleteValue&&""!==e.deleteValue.trim())||!angular.isObject(n)?i.push($q(function(i,o){r(t,n,e,a).then(function(t){i(t)}).catch(function(t){return o(t),!1})})):angular.forEach(n,function(n,o){i.push($q(function(i,u){e.saveValue=""!==e.saveValue.trim()?e.saveValue:"$",e.deleteValue=""!==e.deleteValue.trim()?e.deleteValue:"$",f(t+"/"+o,n,e,a).then(function(t){i(t)}).catch(function(t){return u(t),!1})}))}),$q.all(i)}if(!a)return u(),!1;var s={},l=[];a&&a.map(function(t){l.push($q(function(e,a){f(t.path,n,t,i).then(function(t){e()}).catch(function(t){return a(t),!1})}))}),$q.all(l).then(function(t){u(s)}).catch(function(t){return c(t),!1})})},externalEffect:function(t,n,e,a,i,o){return $q(function(u,c){function r(t){var n=[],a={path:"",if:{key:"",value:""},save:{key:"",value:""},delete:{key:"",value:""}};return t.hasOwnProperty("path")||(t.path=""),n.push($q(function(n){placeIDs(e,o,t.path.split("/"),"#").then(function(t){a.path=t.join("/"),n()})})),t.hasOwnProperty("if")?(t.if.hasOwnProperty("key")||(t.if.key=""),t.if.hasOwnProperty("value")||(t.if.value="")):t.if={key:"",value:""},n.push($q(function(n){placeIDs(e,o,t.if.key.split("/"),"#").then(function(t){a.if.key=t.join("/"),n()})})),n.push($q(function(n){placeIDs(e,o,t.if.value.split("/"),"#").then(function(t){a.if.value=t.join("/"),n()})})),t.hasOwnProperty("save")?(t.save.hasOwnProperty("key")||(t.save.key=""),t.save.hasOwnProperty("value")||(t.save.value="")):t.if={key:"",value:""},n.push($q(function(n){placeIDs(e,o,t.save.key.split("/"),"#").then(function(t){a.save.key=t.join("/"),n()})})),n.push($q(function(n){placeIDs(e,o,t.save.value.split("/"),"#").then(function(t){a.save.value=t.join("/"),n()})})),t.hasOwnProperty("delete")?(t.delete.hasOwnProperty("key")||(t.delete.key=""),t.delete.hasOwnProperty("value")||(t.delete.value="")):t.delete={key:"",value:""},n.push($q(function(n){placeIDs(e,o,t.delete.key.split("/"),"#").then(function(t){a.delete.key=t.join("/"),n()})})),n.push($q(function(n){placeIDs(e,o,t.delete.value.split("/"),"#").then(function(t){a.delete.value=t.join("/"),n()})})),$q(function(t,e){$q.all(n).then(function(){t(a)})})}function s(n,e,a,i){var u=[];return".doNothing"!==a.save.value&&("save"===i?u.push($q(function(u,c){commands.saveValue(t,"1",(e+"/"+a.save.key).split("/"),a.save.value,i,o).then(function(t){angular.equals(n,t)||angular.extend(d,t),u()}).catch(function(t){return c(t),!1})})):u.push($q(function(u,c){commands.deleteValue(t,n,(e+"/"+a.delete.key).split("/"),a.delete.value,i,o).then(function(t){angular.equals(n,t)||angular.extend(d,t),u()}).catch(function(t){return c(t),!1})}))),$q.all(u)}function l(t,n,e,a){var i=[];return angular.forEach(t,function(t,o){i.push($q(function(t,i){s(n,e.path+"/"+o,e,a).then(function(){t()}).catch(function(t){return i(t),!1})}))}),$q.all(i)}if(!a)return u(),!1;var d={},h=[];angular.forEach(a,function(t){h.push($q(function(e,a){r(t).then(function(t){firebase.database().ref(f.baseRef()+"/"+t.path).orderByChild(t.if.key).equalTo(t.if.value).once("value",function(o){l(o.val(),n,t,i).then(function(t){e()}).catch(function(t){return a(t),!1})},function(t){a(t)})})}))}),$q.all(h).then(function(t){u(d)})})},function:function(ref,data,path,options,action,manifestPath){function replace(t){var n=[],e={},a="",i="";return angular.forEach(t,function(t,e){"string"==typeof e&&n.push($q(function(t){placeIDs(path,manifestPath,e.split("/"),"#").then(function(n){a=n.join("/"),t()})})),"string"==typeof t&&n.push($q(function(n){placeIDs(path,manifestPath,t.split("/"),"#").then(function(t){i=t.join("/"),n()})}))}),$q(function(t){$q.all(n).then(function(n){""!==a&&""!==i&&(e[a]=i),t(e)})})}function $function(flatte,$q,$ref,$data,$path,$action,$manifestPath){return $q(function(resolve,reject){try{var res={};eval(options)}catch(t){return reject(t),!1}})}return $q(function(t,n){options?$function(f,$q,ref,data,path,action,manifestPath).then(function(n){t(n)}).catch(function(t){return n(t),!1}):t()})}},tasks=[createAction,createObjects,loopData,perform,createFinalResults,update,endAction];return $q(function(t,n){f.serial(tasks).then(function(){mxFlatte.settings.debug?t({results:doAction.var[guid].results||"No save result generated !..",manifestInfections:doAction.var[guid].appliedManifest}):(delete doAction.var[guid],t()),f.debug("flatte.do() ended with success")}).catch(function(t){n(t)})})}var f=this;f.debug=debug,f.serial=serial,f.db=firebase.database(),f.dbref=f.db.ref(),f.dbTime=function(){return firebase.database.ServerValue.TIMESTAMP},f.dbKey=function(){return firebase.database().ref().push().key},f.cleanData=function(t){return JSON.parse(JSON.serialize(t))},f.setManifest=function(t){mxFlatte.settings.manifest=t},f.setPredefined=function(t){mxFlatte.settings.predefined=t},f.predefined=function(t,n){if(!t)return mxFlatte.settings.predefined;"object"==typeof t?angular.forEach(t,function(t,n){mxFlatte.settings.predefined[n]=t}):mxFlatte.settings.predefined[t]=n},f.baseRef=function(t){if(!t)return mxFlatte.settings.baseRef;mxFlatte.settings.baseRef=t},f.do=doAction,doAction.var={},doAction.getDebug=function(){return this.var},doAction.clearDebug=function(){this.var={}}}angular.module("mx.flatte",[]).provider("mxFlatte",flatteProvider).run(flatteRun).service("flatte",flatte),flatteProvider.$inject=[],flatteRun.$inject=["mxFlatte"],flatte.$inject=["mxFlatte","$q","$filter","$timeout"]}();