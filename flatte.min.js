/**
 * Nosql denormalization management for Firabase
 * @link https://flatte.github.io/Flatte-Web/
 * @version v1.0.23 - 05.08.2017 
 *
 * Copyright (c) 2017 Flatte - Sezer Ekinci <sezer@maxabab.com>, Kaan Ekinci <kaan@maxabab.com> 
 * @license MIT License, https://opensource.org/licenses/MIT
 *
 * @author Sezer Ekinci <sezer@maxabab.com>
 * @author Kaan Ekinci <kaan@maxabab.com>
 */
!function(){"use strict";function flatteProvider(){function t(t,n){var a=function(){return t(function(t,n){if(!e.con||!e.con.database){var a={code:"FB000",message:"Connection Error: settings.con is not defined."};return console.error("[Flatte] Connection Error: ",a),n(a),!1}e.con.database().ref(".info/connected").once("value",function(n){e.debug&&console.info("%c♣ [Flatte] Connection Success.","color:#3883fa;"),e.conStatus=!0,t(!0)},function(t){return e.debug&&console.error("[Flatte] Connection Error: ",t),e.conStatus=!1,n(t),!1})})};return{settings:e,checkConnection:a}}var n=this,e={debug:!1,auth:!1,baseRef:"/",conStatus:!1,con:null,manifest:null};n.settings=function(t){angular.extend(e,t)},n.$get=t,t.$inject=["$q","$injector"]}function flatteRun(t){t.checkConnection()}function flatte(mxFlatte,$q,$filter,$timeout){function debug(t){mxFlatte.settings.debug&&(angular.isObject(t)?console.info("%c♣ ["+t.code+"] "+t.message,"color:#3883fa;"):console.info("%c♣ "+t,"color:#3883fa;"))}function serial(t){var n;return angular.forEach(t,function(t,e){n=n?n.then(t).catch(function(t){return $q.reject(t)}):t()}),n||$q.when()}function doAction(saveObjects){function createAction(){return f.debug("Create action."),$q(function(t,n){if(f.debug("Set action container."),doAction.var[guid]={log:{startedAt:moment()},objects:{},results:{},appliedManifest:[]},f.debug("Check sent data"),!saveObjects)return endAction(e={code:"F001",message:"Object not found! Please send object first."}),n(e),!1;if(!angular.isArray(saveObjects)){var e={code:"F002",message:"Object is not array! Please send object as an array."};return endAction(e),n(e),!1}t()})}function createObjects(){var t=[];return angular.forEach(saveObjects,function(n){t.push($q(function(t,e){if(!n.ref)return endAction(a={code:"F003",message:"Object referance not found! Please send object referance first."}),e(a),!1;if(!n.data){var a={code:"F004",message:"Object data not found! Please send object data first. (ref: "+n.ref+")"};return endAction(a),e(a),!1}doAction.var[guid].objects[n.ref]={ref:n.ref,data:n.data,set:n.set,$action:"delete"===n.data?"delete":"save",$exists:{},$ids:{},$ref:n.ref.split("/"),$results:{}},"delete"!==n.data&&(doAction.var[guid].objects[n.ref].$exists[n.ref]=!0),createLoopData(doAction.var[guid].objects[n.ref]).then(function(){t()}).catch(function(t){return e(t),!1})}))}),$q.all(t)}function getDbData(t){return $q(function(n,e){firebase.database().ref(f.baseRef()+"/"+t).once("value",function(t){n(t.val()||{})},function(t){return e(t),!1})})}function createExists(t,n,e){var a=[];return angular.forEach(n,function(n,o){a.push($q(function(a,r){var c=e?angular.copy(e):[];c.push(o),doAction.var[guid].objects[t].$exists[c.join("/")]=!0,angular.isObject(n)?createExists(t,n,c).then(function(){a()}).catch(function(t){return r(t),!1}):a()}))}),$q.all(a)}function createLoopData(t){return $q(function(n,e){"save"!==t.$action||t.set?getDbData(t.ref).then(function(a){t.set?createExists(t.ref,t.data,t.$ref).then(function(){doAction.var[guid].objects[t.ref].data=angular.extend(a,doAction.var[guid].objects[t.ref].data),n()}).catch(function(t){return e(t),!1}):(doAction.var[guid].objects[t.ref].data=a,n())}).catch(function(t){return e(t),!1}):n()})}function perform(){var t=[];return angular.forEach(doAction.var[guid].objects,function(n){t.push($q(function(t,e){createIdPaths(n.ref,n.$ref).then(function(a){applyManifest(n.ref,n.data,n.$ref,a).then(function(){t()}).catch(function(t){return e(t),!1})}).catch(function(t){return e(t),!1})})),t.push($q(function(t,e){loopData(n.ref,n.data,n.$ref).then(function(){t()}).catch(function(t){return e(t),!1})}))}),$q.all(t)}function loopData(t,n,e){var a=[];return angular.forEach(n,function(n,o){var r=e?angular.copy(e):[];r.push(o),a.push($q(function(e,a){angular.isObject(n)?loopData(t,n,r).then(function(){e()}).catch(function(t){return a(t),!1}):e()})),a.push($q(function(e,a){createIdPaths(t,r).then(function(o){applyManifest(t,n,r,o).then(function(){e()}).catch(function(t){return a(t),!1})}).catch(function(t){return a(t),!1})}))}),$q.all(a)}function createIdPaths(ref,path){return $q(function(resolve,reject){var promises=[],newPath=[],hasItem=!1,notFound=!1;return angular.forEach(path,function(item){promises.push($q(function(resolve,reject){try{hasItem=eval("mxFlatte.settings.manifest.data"+(newPath.length>0?"['"+newPath.join("'].childs['")+"'].childs":"")+".hasOwnProperty('"+item+"')")}catch(t){hasItem=!1}if(hasItem)newPath.push(item),resolve();else{if(mxFlatte.settings.manifest.hasOwnProperty("id_index")&&mxFlatte.settings.manifest.id_index.hasOwnProperty(newPath.join(">")+">ID")){var ID=mxFlatte.settings.manifest.id_index[newPath.join(">")+">ID"];newPath.push(ID),doAction.var[guid].objects[ref].$ids["#"+ID]=item}else notFound=notFound||!0;resolve()}}))}),$q.all(promises).then(function(){resolve(!notFound&&newPath)}).catch(function(t){return reject(t),!1})})}function applyManifest(ref,data,path,manifestPath){return $q(function(resolve,reject){var manifest={},promises=[],action;action=doAction.var[guid].objects[ref].$exists[path.join("/")]||"permanent"!==doAction.var[guid].objects[ref].set?"permanent"!==doAction.var[guid].objects[ref].set&&("delete"===doAction.var[guid].objects[ref].$action||"save"===doAction.var[guid].objects[ref].$action&&!doAction.var[guid].objects[ref].$exists[path.join("/")]&&doAction.var[guid].objects[ref].set)?"delete":"save":"setNull";try{(manifest=eval("mxFlatte.settings.manifest.data"+(manifestPath.length>0?"['"+manifestPath.join("'].childs['")+"']":"")+"._q"))&&doAction.var[guid].appliedManifest.push(manifestPath.length>0?manifestPath.join("/"):"")}catch(t){return reject(t),!1}for(var command in commands)promises.push($q(function(t,n){commands[command](ref,data,path,manifest&&manifest.hasOwnProperty(command)&&""!==manifest[command]?manifest[command]:null,action).then(function(n){$.extend(doAction.var[guid].objects[ref].$results,n),t()}).catch(function(t){return n(t),!1})}));$q.all(promises).then(function(){resolve()}).catch(function(t){return reject(t),!1})})}function createFinalResults(){var t=[];return angular.forEach(doAction.var[guid].objects,function(n){t.push($q(function(t,e){_replace(n.ref,n.$results).then(function(e){doAction.var[guid].objects[n.ref].$results=e,$.extend(doAction.var[guid].results,e),t()}).catch(function(t){return e(t),!1})}))}),$q.all(t)}function _replace(t,n){var e=[],a={};return angular.forEach(n,function(n,o){e.push($q(function(e,r){_replaceIDs(t,o).then(function(o){_replaceIDs(t,n).then(function(t){a[o]=preDefined.hasOwnProperty(t)?preDefined[t]:t,e()}).catch(function(t){return r(t),!1})}).catch(function(t){return r(t),!1})}))}),$q(function(t,n){$q.all(e).then(function(){t(a)})})}function _replaceIDs(t,n){var e=[],a=angular.copy(n);return a&&"string"==typeof a&&angular.forEach(doAction.var[guid].objects[t].$ids,function(t,n){e.push($q(function(e,o){var r=new RegExp(n.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),"g");a=a.replace(r,t),e()}))}),$q(function(t,n){$q.all(e).then(function(){t(a)})})}function update(){return f.debug("Run Update."),$q(function(t,n){firebase.database().ref(f.baseRef()).update(doAction.var[guid].results,function(e){e?n(e):t()})})}function endAction(t){return $q(function(n,e){doAction.var[guid].log.endedAt=moment(),doAction.var[guid].log.duration=moment.duration(doAction.var[guid].log.endedAt.diff(doAction.var[guid].log.startedAt)).asMilliseconds()+" milliseconds",doAction.var[guid].log._error=t||null,n()})}f.debug("flatte.do() called...");var guid="GUID"+f.dbKey(),preDefined={".timestamp":firebase.database.ServerValue.TIMESTAMP,".auth":mxFlatte.settings.auth,".test":{test_a:1}},commands={ID:function(t,n,e,a,o){return $q(function(t,n){t()})},saveValue:function(t,n,e,a,o){return $q(function(t,r){var c={};if("doNothing"!==a&&"save"===o&&!angular.isObject(n))if(e=angular.isObject(e)?e.join("/"):e,angular.isObject(a)){var i=a.hasOwnProperty("params")?a.params.split(":"):[];i.unshift(n),c[e]=$filter(a.filter).apply(this,i)}else c[e]=null===a||"$"===a?n:a;t(c)})},deleteValue:function(t,n,e,a,o){return $q(function(t,r){var c={};"doNothing"===a||angular.isObject(n)||(e=angular.isObject(e)?e.join("/"):e,"delete"===o?c[e]=null===a||"$"===a?n:a:"setNull"===o&&(c[e]=null)),t(c)})},copy:function(t,n,e,a,o){return $q(function(e,r){function c(n,e,a){var o=[];return o.push($q(function(o,r){commands.saveValue(t,n,e.path.split("/"),e.saveValue,a).then(function(t){angular.extend(u,t),o()}).catch(function(t){return r(t),!1})})),o.push($q(function(o,r){commands.deleteValue(t,n,e.path.split("/"),e.deleteValue,a).then(function(t){angular.extend(u,t),o()}).catch(function(t){return r(t),!1})})),$q.all(o)}function i(t,n,e){var a=[];return angular.isObject(t)?angular.forEach(t,function(t,o){a.push($q(function(a,o){i(t,n,e).then(function(t){a(t)}).catch(function(t){return o(t),!1})}))}):a.push($q(function(a,o){c(t,n,e).then(function(t){a(t)}).catch(function(t){return o(t),!1})})),$q.all(a)}if(!a)return e(),!1;var u={},f=[];a&&a.map(function(t){f.push($q(function(e,a){i(n,t,o).then(function(t){e()}).catch(function(t){return a(t),!1})}))}),$q.all(f).then(function(t){e(u)}).catch(function(t){return r(t),!1})})},externalEffect:function(t,n,e,a,o){return $q(function(e,r){function c(n){return $q(function(e,a){_replace(t,n).then(function(a){_replace(t,(n=a).if).then(function(a){n.if=a,_replaceIDs(t,n.save.key).then(function(a){n.save.key=a,_replaceIDs(t,n.delete.key).then(function(t){n.delete.key=t,e(n)})})})})})}function i(n,e,a,o){var r=[];return"doNothing"!==a.save.value&&("save"===o?r.push($q(function(n,r){commands.saveValue(t,"1",(e+"/"+a.save.key).split("/"),a.save.value,o).then(function(t){angular.extend(s,t),n()}).catch(function(t){return r(t),!1})})):r.push($q(function(r,c){commands.deleteValue(t,n,(e+"/"+a.delete.key).split("/"),a.delete.value,o).then(function(t){angular.extend(s,t),r()}).catch(function(t){return c(t),!1})}))),$q.all(r)}function u(t,n,e,a){var o=[];return angular.forEach(t,function(t,r){o.push($q(function(t,o){i(n,e.path+"/"+r,e,a).then(function(){t()}).catch(function(t){return o(t),!1})}))}),$q.all(o)}if(!a)return e(),!1;var s={},l=[];angular.forEach(a,function(t){l.push($q(function(e,a){c(t).then(function(t){firebase.database().ref(f.baseRef()+"/"+t.path).orderByChild(t.if.key).equalTo(t.if.value).once("value",function(r){u(r.val(),n,t,o).then(function(t){e()}).catch(function(t){return a(t),!1})},function(t){a(t)})})}))}),$q.all(l).then(function(t){e(s)})})},function:function(ref,data,path,options,action){function $function(flatte,$q,$ref,$data,$path,$action){return $q(function(resolve,reject){try{var res={};eval(options)}catch(t){return reject(t),!1}})}return $q(function(t,n){options?$function(f,$q,ref,data,path,action).then(function(n){t(n)}).catch(function(t){return n(t),!1}):t()})}},tasks=[createAction,createObjects,loopData,perform,createFinalResults,update,endAction];return $q(function(t,n){f.serial(tasks).then(function(){mxFlatte.settings.debug?t({results:doAction.var[guid].results||"No save result generated !..",manifestInfections:doAction.var[guid].appliedManifest}):(delete doAction.var[guid],t()),f.debug("flatte.do() ended with success")}).catch(function(t){n(t)})})}var f=this;f.debug=debug,f.serial=serial,f.db=firebase.database(),f.dbref=f.db.ref(),f.dbTime=function(){return firebase.database.ServerValue.TIMESTAMP},f.dbKey=function(){return firebase.database().ref().push().key},f.cleanData=function(t){return JSON.parse(JSON.serialize(t))},f.setManifest=function(t){mxFlatte.settings.manifest=t},f.auth=function(t){return t?void(mxFlatte.settings.auth=t):mxFlatte.settings.auth},f.baseRef=function(t){return t?void(mxFlatte.settings.baseRef=t):mxFlatte.settings.baseRef},f.do=doAction,doAction.var={},doAction.getDebug=function(){return this.var}}angular.module("mx.flatte",[]).provider("mxFlatte",flatteProvider).run(flatteRun).service("flatte",flatte),flatteProvider.$inject=[],flatteRun.$inject=["mxFlatte"],flatte.$inject=["mxFlatte","$q","$filter","$timeout"]}();
