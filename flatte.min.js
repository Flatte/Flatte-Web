/**
 * Nosql denormalization management for Firabase
 * @link https://flatte.github.io/Flatte-Web/
 * @version v1.0.23 - 05.08.2017 
 *
 * Copyright (c) 2017 Flatte - Sezer Ekinci <sezer@maxabab.com>, Kaan Ekinci <kaan@maxabab.com> 
 * @license MIT License, https://opensource.org/licenses/MIT
 *
 * @author Sezer Ekinci <sezer@maxabab.com>
 * @author Kaan Ekinci <kaan@maxabab.com>
 */
!function(){"use strict";function flatteProvider(){function t(t){var e=function(){return t(function(t,e){if(!n.con||!n.con.database){var a={code:"FB000",message:"Connection Error: settings.con is not defined."};return console.error("[Flatte] Connection Error: ",a),e(a),!1}n.con.database().ref(".info/connected").once("value",function(){n.debug&&console.info("%c♣ [Flatte] Connection Success.","color:#3883fa;"),n.conStatus=!0,t(!0)},function(t){return n.debug&&console.error("[Flatte] Connection Error: ",t),n.conStatus=!1,e(t),!1})})};return{settings:n,checkConnection:e}}var e=this,n={debug:!1,auth:!1,baseRef:"/",conStatus:!1,con:null,manifest:null};e.settings=function(t){angular.extend(n,t)},e.$get=t,t.$inject=["$q","$injector"]}function flatteRun(t){t.checkConnection()}function flatte(mxFlatte,$q,$filter,$timeout){function debug(t){mxFlatte.settings.debug&&(angular.isObject(t)?console.info("%c♣ ["+t.code+"] "+t.message,"color:#3883fa;"):console.info("%c♣ "+t,"color:#3883fa;"))}function serial(t){var e;return angular.forEach(t,function(t){e=e?e.then(t).catch(function(t){return $q.reject(t)}):t()}),e||$q.when()}function doAction(saveObjects){function createAction(){return f.debug("Create action."),$q(function(t,e){if(f.debug("Set action container."),doAction.var[guid]={log:{startedAt:moment()},objects:{},results:{}},f.debug("Check sent data"),!saveObjects){var n={code:"F001",message:"Object not found! Please send object first."};return endAction(n),e(n),!1}if(!angular.isArray(saveObjects)){var n={code:"F002",message:"Object is not array! Please send object as an array."};return endAction(n),e(n),!1}t()})}function createObjects(){var t=[];return angular.forEach(saveObjects,function(e){t.push($q(function(t,n){if(!e.ref){var a={code:"F003",message:"Object referance not found! Please send object referance first."};return endAction(a),n(a),!1}if(!e.data){var a={code:"F004",message:"Object data not found! Please send object data first. (ref: "+e.ref+")"};return endAction(a),n(a),!1}doAction.var[guid].objects[e.ref]={ref:e.ref,data:e.data,set:e.set,$action:"delete"===e.data?"delete":"save",$exists:{},$ids:{},$ref:e.ref.split("/"),$results:{}},"delete"!==e.data&&(doAction.var[guid].objects[e.ref].$exists[e.ref]=!0),createLoopData(doAction.var[guid].objects[e.ref]).then(function(){t()}).catch(function(t){return n(t),!1})}))}),$q.all(t)}function getDbData(t){return $q(function(e,n){firebase.database().ref(f.baseRef()+"/"+t).once("value",function(t){e(t.val()||{})},function(t){return n(t),!1})})}function createExists(t,e,n){var a=[];return angular.forEach(e,function(e,r){a.push($q(function(a,o){var c=n?angular.copy(n):[];c.push(r),doAction.var[guid].objects[t].$exists[c.join("/")]=!0,angular.isObject(e)?createExists(t,e,c).then(function(){a()}).catch(function(t){return o(t),!1}):a()}))}),$q.all(a)}function createLoopData(t){return $q(function(e,n){"save"!==t.$action||t.set?getDbData(t.ref).then(function(a){t.set?createExists(t.ref,t.data,t.$ref).then(function(){doAction.var[guid].objects[t.ref].data=angular.extend(a,doAction.var[guid].objects[t.ref].data),e()}).catch(function(t){return n(t),!1}):(doAction.var[guid].objects[t.ref].data=a,e())}).catch(function(t){return n(t),!1}):e()})}function perform(){var t=[];return angular.forEach(doAction.var[guid].objects,function(e){t.push($q(function(t,n){createIdPaths(e.ref,e.$ref).then(function(a){applyManifest(e.ref,e.data,e.$ref,a).then(function(){t()}).catch(function(t){return n(t),!1})}).catch(function(t){return n(t),!1})})),t.push($q(function(t,n){loopData(e.ref,e.data,e.$ref).then(function(){t()}).catch(function(t){return n(t),!1})}))}),$q.all(t)}function loopData(t,e,n){var a=[];return angular.forEach(e,function(e,r){var o=n?angular.copy(n):[];o.push(r),a.push($q(function(n,a){angular.isObject(e)?loopData(t,e,o).then(function(){n()}).catch(function(t){return a(t),!1}):n()})),a.push($q(function(n,a){createIdPaths(t,o).then(function(r){applyManifest(t,e,o,r).then(function(){n()}).catch(function(t){return a(t),!1})}).catch(function(t){return a(t),!1})}))}),$q.all(a)}function createIdPaths(ref,path){return $q(function(resolve,reject){var promises=[],newPath=[],hasItem=!1,notFound=!1;return angular.forEach(path,function(item){promises.push($q(function(resolve,reject){try{hasItem=eval("mxFlatte.settings.manifest.data"+(newPath.length>0?"['"+newPath.join("'].childs['")+"'].childs":"")+".hasOwnProperty('"+item+"')")}catch(err){hasItem=!1}if(hasItem)newPath.push(item),resolve();else{if(mxFlatte.settings.manifest.id_index.hasOwnProperty(newPath.join(">")+">ID")){var ID=mxFlatte.settings.manifest.id_index[newPath.join(">")+">ID"];newPath.push(ID),doAction.var[guid].objects[ref].$ids["#"+ID]=item}else notFound=notFound||!0;resolve()}}))}),$q.all(promises).then(function(){resolve(notFound?!1:newPath)}).catch(function(t){return reject(t),!1})})}function applyManifest(ref,data,path,manifestPath){return $q(function(resolve,reject){var manifest={},promises=[],action;action=doAction.var[guid].objects[ref].$exists[path.join("/")]||"permanent"!==doAction.var[guid].objects[ref].set?"permanent"!==doAction.var[guid].objects[ref].set&&("delete"===doAction.var[guid].objects[ref].$action||"save"===doAction.var[guid].objects[ref].$action&&!doAction.var[guid].objects[ref].$exists[path.join("/")]&&doAction.var[guid].objects[ref].set)?"delete":"save":"setNull";try{manifest=eval("mxFlatte.settings.manifest.data"+(manifestPath.length>0?"['"+manifestPath.join("'].childs['")+"']":"")+"._q")}catch(err){return reject(err),!1}for(var command in commands)promises.push($q(function(t,e){commands[command](ref,data,path,manifest&&manifest.hasOwnProperty(command)&&""!==manifest[command]?manifest[command]:null,action).then(function(e){$.extend(doAction.var[guid].objects[ref].$results,e),t()}).catch(function(t){return e(t),!1})}));$q.all(promises).then(function(){resolve()}).catch(function(t){return reject(t),!1})})}function createFinalResults(){var t=[];return angular.forEach(doAction.var[guid].objects,function(e){t.push($q(function(t,n){_replace(e.ref,e.$results,!0).then(function(n){doAction.var[guid].objects[e.ref].$results=n,$.extend(doAction.var[guid].results,n),t()}).catch(function(t){return n(t),!1})}))}),$q.all(t)}function _replace(ref,data,checkObjectData){function objToStr(data,path){var promises=[],results={};return angular.forEach(data,function(value,key){var newPath=path||[];promises.push($q(angular.isObject(value)?function(t,e){try{newPath.push(key),objToStr(value,newPath).then(function(){t()}).catch(function(t){e(t)})}catch(n){console.log(n),e(n)}}:function(resolve,reject){try{eval("results"+(newPath.length>0?"['"+newPath.join("/")+"/"+key+"']":"['"+key+"']")+" = value")}catch(err){console.log(err),reject(err)}resolve()}))}),$q(function(t,e){$q.all(promises).then(function(){t(results)}).catch(function(t){return e(t),!1})})}var promises=[],results={};return angular.forEach(data,function(t,e){promises.push($q(function(n,a){_replaceIDs(ref,e).then(function(e){_replaceIDs(ref,t).then(function(t){var a=preDefined.hasOwnProperty(t)?preDefined[t]:t;angular.isObject(a)&&checkObjectData&&".timestamp"!==t?objToStr(a,e.split("/")).then(function(t){angular.extend(results,t),n()}).catch(function(){}):(results[e]=a,n())}).catch(function(t){return a(t),!1})}).catch(function(t){return a(t),!1})}))}),$q(function(t){$q.all(promises).then(function(){t(results)})})}function _replaceIDs(t,e){var n=[],a=angular.copy(e);return a&&"string"==typeof a&&angular.forEach(doAction.var[guid].objects[t].$ids,function(t,e){n.push($q(function(n){var r=RegExp(e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),"g");a=a.replace(r,t),n()}))}),$q(function(t){$q.all(n).then(function(){t(a)})})}function update(){return f.debug("Run Update."),console.log("update",doAction.var[guid].results),$q(function(t,e){firebase.database().ref(f.baseRef()).update(doAction.var[guid].results,function(n){n?e(n):t()})})}function prepareEnd(){return f.debug("Prepare ending."),$q(function(t){mxFlatte.settings.debug?t(doAction.var[guid].results||"No save result generated !.."):delete doAction.var[guid],f.debug("flatte.do() ended with success"),t(guid)})}function endAction(t){doAction.var[guid].log.endedAt=moment(),doAction.var[guid].log.duration=moment.duration(doAction.var[guid].log.endedAt.diff(doAction.var[guid].log.startedAt)).asMilliseconds()+" milliseconds",doAction.var[guid].log._error=t||null}f.debug("flatte.do() called...");var guid="GUID"+f.dbKey(),preDefined={".timestamp":firebase.database.ServerValue.TIMESTAMP,".auth":mxFlatte.settings.auth},commands={ID:function(){return $q(function(t){t()})},saveValue:function(t,e,n,a,r){return $q(function(o){var c={};if("doNothing"!==a&&"save"===r&&!angular.isObject(e))if(n=angular.isObject(n)?n.join("/"):n,angular.isObject(a)){var i=null;if(i=null===a.$value||""===a.$value||"$"===a.$value?e:doAction.commands._replaceIDs(guid,t,a.$value),"filter"===a.$type){var u=a.$params.split(":");u.unshift(i),c[n]=$filter(a.$filter).apply(this,u)}}else c[n]=null===a||"$"===a?e:a;o(c)})},deleteValue:function(t,e,n,a,r){return $q(function(t){var o={};"doNothing"===a||angular.isObject(e)||(n=angular.isObject(n)?n.join("/"):n,"delete"===r?o[n]=null===a||"$"===a?e:a:"setNull"===r&&(o[n]=null)),t(o)})},copy:function(t,e,n,a,r){return $q(function(n,o){function c(e,n,a){var r=[];return r.push($q(function(r,o){commands.saveValue(t,e,n.path.split("/"),n.saveValue,a).then(function(t){angular.extend(u,t),r()}).catch(function(t){return o(t),!1})})),r.push($q(function(r,o){commands.deleteValue(t,e,n.path.split("/"),n.deleteValue,a).then(function(t){angular.extend(u,t),r()}).catch(function(t){return o(t),!1})})),$q.all(r)}function i(t,e,n){var a=[];return angular.isObject(t)?angular.forEach(t,function(t){a.push($q(function(a,r){i(t,e,n).then(function(t){a(t)}).catch(function(t){return r(t),!1})}))}):a.push($q(function(a,r){c(t,e,n).then(function(t){a(t)}).catch(function(t){return r(t),!1})})),$q.all(a)}if(!a)return n(),!1;var u={},s=[];a&&a.map(function(t){s.push($q(function(n,a){i(e,t,r).then(function(){n()}).catch(function(t){return a(t),!1})}))}),$q.all(s).then(function(){n(u)}).catch(function(t){return o(t),!1})})},externalEffect:function(t,e,n,a,r){return $q(function(n){function o(e){return $q(function(n){_replace(t,e).then(function(a){e=a,_replace(t,e.if).then(function(a){e.if=a,_replaceIDs(t,e.save.key).then(function(a){e.save.key=a,_replaceIDs(t,e.delete.key).then(function(t){e.delete.key=t,n(e)})})})})})}function c(e,n,a,r){var o=[];return"doNothing"!==a.save.value&&o.push("save"===r?$q(function(e,o){commands.saveValue(t,"1",(n+"/"+a.save.key).split("/"),a.save.value,r).then(function(t){angular.extend(u,t),e()}).catch(function(t){return o(t),!1})}):$q(function(o,c){commands.deleteValue(t,e,(n+"/"+a.delete.key).split("/"),a.delete.value,r).then(function(t){angular.extend(u,t),o()}).catch(function(t){return c(t),!1})})),$q.all(o)}function i(t,e,n,a){var r=[];return angular.forEach(t,function(t,o){r.push($q(function(t,r){c(e,n.path+"/"+o,n,a).then(function(){t()}).catch(function(t){return r(t),!1})}))}),$q.all(r)}if(!a)return n(),!1;var u={},s=[];angular.forEach(a,function(t){s.push($q(function(n,a){o(t).then(function(t){firebase.database().ref(f.baseRef()+"/"+t.path).orderByChild(t.if.key).equalTo(t.if.value).once("value",function(o){i(o.val(),e,t,r).then(function(){n()}).catch(function(t){return a(t),!1})},function(t){a(t)})})}))}),$q.all(s).then(function(){n(u)})})},"function":function(ref,data,path,options,action){function $function(flatte,$q,$ref,$data,$path,$action){return $q(function(resolve,reject){try{var res={};eval(options)}catch(err){return reject(err),!1}})}return $q(function(t,e){options?$function(f,$q,ref,data,path,action).then(function(e){t(e)}).catch(function(t){return e(t),!1}):t()})}},tasks=[createAction,createObjects,loopData,perform,createFinalResults,update,prepareEnd,endAction];return f.serial(tasks)}var f=this;f.debug=debug,f.serial=serial,f.db=firebase.database(),f.dbref=f.db.ref(),f.dbTime=function(){return firebase.database.ServerValue.TIMESTAMP},f.dbKey=function(){return firebase.database().ref().push().key},f.cleanData=function(t){return JSON.parse(JSON.serialize(t))},f.setManifest=function(t){mxFlatte.settings.manifest=t},f.auth=function(t){return t?void(mxFlatte.settings.auth=t):mxFlatte.settings.auth},f.baseRef=function(t){return t?void(mxFlatte.settings.baseRef=t):mxFlatte.settings.baseRef},f.do=doAction,doAction.var={},doAction.getDebug=function(){return this.var}}angular.module("mx.flatte",[]).provider("mxFlatte",flatteProvider).run(flatteRun).service("flatte",flatte),flatteProvider.$inject=[],flatteRun.$inject=["mxFlatte"],flatte.$inject=["mxFlatte","$q","$filter","$timeout"]}();
